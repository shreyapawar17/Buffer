<!DOCTYPE html>
<html>
<head>
    <title>Dynamic Safe Route Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    <script src="https://cdn.jsdelivr.net/gh/python-visualization/folium@main/folium/templates/leaflet_heat.min.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
        #mapid { width: 100%; height: 75vh; }
        #controls { padding: 10px; text-align: center; background-color: #f8f8f8; }
        #destination { padding: 10px; border-radius: 5px; border: 1px solid #ccc; margin-right: 10px; width: 60%; max-width: 300px; }
        button { padding: 10px 20px; border: none; border-radius: 5px; background-color: #007bff; color: white; cursor: pointer; transition: background-color 0.3s ease; font-size: 1em; }
        button:hover { background-color: #0056b3; }
        #route-info { margin-top: 15px; font-weight: bold; }
        #error-info { color: red; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="controls">
        <h1>Dynamic Safe Route Map</h1>
        <p>Enter your destination:</p>
        <input type="text" id="destination" placeholder="Enter destination">
        <button onclick="calculateRoute()">Find Safest Route</button>
        <p id="route-info"></p>
        <p id="error-info"></p>
    </div>
    <div id="mapid"></div>

    <script>
        let map = L.map('mapid').setView([18.5204, 73.8567], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
        }).addTo(map);

        let safestRouteLayer;
        let destinationMarker;
        let userMarker;
        let heatmapLayer;
        let safeSpaceLayer = L.layerGroup();
        let layerControl = L.control.layers(null, { 'Safest Route': safestRouteLayer, 'Unsafe Areas': heatmapLayer, 'Safe Spaces': safeSpaceLayer }).addTo(map);

        function createAwesomeMarker(color, icon) {
            return L.AwesomeMarkers.icon({
                markerColor: color,
                iconColor: 'white',
                icon: icon,
                prefix: 'glyphicon',
                extraClasses: 'fa-rotate-0'
            });
        }

        async function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const latlng = [position.coords.latitude, position.coords.longitude];
                            resolve(latlng);
                            if (!userMarker) {
                                userMarker = L.marker(latlng, {icon: createAwesomeMarker('red', 'user')}).addTo(map).bindPopup("Your Location").openPopup();
                                map.setView(latlng, 15);
                            } else {
                                userMarker.setLatLng(latlng);
                                map.panTo(latlng);
                            }
                        },
                        error => {
                            document.getElementById('error-info').textContent = 'Error getting location: ' + error.message;
                            resolve([18.5204, 73.8567]); // Default to Pune on error
                        },
                        { enableHighAccuracy: false, timeout: 5000, maximumAge: 0 }
                    );
                } else {
                    document.getElementById('error-info').textContent = 'Geolocation is not supported by your browser.';
                    resolve([18.5204, 73.8567]); // Default to Pune if no support
                }
            });
        }

        async function fetchInitialData() {
            fetch('http://127.0.0.1:5000/unsafe_data') // Adjust URL if your backend is running elsewhere
                .then(response => response.json())
                .then(data => {
                    if (data.unsafe_reports) {
                        const heatData = data.unsafe_reports.map(r => [r.lat, r.lon, r.intensity]);
                        heatmapLayer = L.heatLayer(heatData, { radius: 25 }).addTo(map);
                        layerControl.addOverlay(heatmapLayer, 'Unsafe Areas');
                    }
                    if (data.safe_spaces) {
                        data.safe_spaces.forEach(space => {
                            const marker = L.marker([space.lat, space.lon], { icon: createAwesomeMarker('green', 'shield') })
                                .bindPopup(`<b>Safe Space:</b> ${space.name}<br>${space.description || ''}`);
                            safeSpaceLayer.addLayer(marker);
                        });
                        safeSpaceLayer.addTo(map);
                        layerControl.addOverlay(safeSpaceLayer, 'Safe Spaces');
                    }
                })
                .catch(error => {
                    console.error('Error fetching initial data:', error);
                    document.getElementById('error-info').textContent = 'Error loading initial map data.';
                });
        }

        async function calculateRoute() {
            const destination = document.getElementById('destination').value;
            if (!destination) {
                alert('Please enter a destination.');
                return;
            }

            document.getElementById('error-info').textContent = ''; // Clear any previous errors
            const currentLocation = await getCurrentLocation();
            const origin_lat = currentLocation[0];
            const origin_lon = currentLocation[1];

            fetch('http://127.0.0.1:5000/safest_route/calculate', { // Adjust URL if your backend is running elsewhere
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ origin_lat, origin_lon, destination })
            })
            .then(response => response.json())
            .then(data => {
                if (data.path) {
                    document.getElementById('route-info').textContent = `Safest Route Found (Approx. ${(data.distance || 0).toFixed(2)} km)`;
                    if (safestRouteLayer) {
                        map.removeLayer(safestRouteLayer);
                    }
                    safestRouteLayer = L.polyline(data.path, { color: 'green', weight: 5 }).addTo(map);
                    layerControl.addOverlay(safestRouteLayer, 'Safest Route');
                    const bounds = L.latLngBounds(data.path);
                    map.fitBounds(bounds);

                    if (destinationMarker) {
                        map.removeLayer(destinationMarker);
                    }
                    const lastPoint = data.path[data.path.length - 1];
                    destinationMarker = L.marker(lastPoint, {icon: createAwesomeMarker('green', 'flag')}).addTo(map).bindPopup(`Destination: ${destination}`).openPopup();
                } else if (data.error) {
                    document.getElementById('route-info').textContent = `Error: ${data.error}`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('error-info').textContent = 'Error calculating route.';
            });
        }

        getCurrentLocation();
        fetchInitialData();
    </script>
</body>
</html>